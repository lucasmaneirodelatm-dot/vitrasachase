<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Parada</title>
<link rel="stylesheet" href="../styles.css">
</head>
<body>

<h2>ğŸš Parada 00</h2>

<div id="infoParada"></div>
<div id="buses"></div>

<h3>ğŸ” Consultar ubicaciÃ³n del bus</h3>
<input id="busId" placeholder="ID del bus (p.ej. BUS1)">
<button onclick="askBus()">Â¿DÃ³nde estÃ¡?</button>
<div id="busLoc"></div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const paradaActual = urlParams.get("parada") || "00";

document.getElementById("infoParada").innerHTML =
    "<strong>Parada actual:</strong> " + paradaActual;

function askBus(){
    const id = document.getElementById("busId").value;
    parent.postMessage({ type: "askBus", bus: id }, "*");
}

window.addEventListener("message", ev => {

    if(ev.data.type === "worldUpdate"){
        const { buses } = ev.data.data;

        const list = Object.values(buses).filter(b => b.next === paradaActual);

        document.getElementById("buses").innerHTML = list.length === 0 ?
            "<p>No hay buses prÃ³ximos.</p>" :
            list.map(b => `
                <div class="busCard">
                    ğŸšŒ ${b.linea} â€” llega en ${b.eta}s
                    ${b.eta < 10 ? 
                        `<button class="btn" onclick="parent.postMessage({ type:'cogerBus', bus:'${b.id}' }, '*')">COGER</button>` 
                        : `<small>Esperando...</small>`}
                </div>
            `).join("");
    }

    if(ev.data.type === "busInfo"){
        if(ev.data.data === null){
            document.getElementById("busLoc").innerHTML = "âŒ Bus no encontrado";
            return;
        }
        const b = ev.data.data;
        document.getElementById("busLoc").innerHTML =
            `ğŸšŒ ${b.id}: prÃ³xima ${b.next} en ${b.eta}s`;
    }

});
</script>

</body>
</html>
