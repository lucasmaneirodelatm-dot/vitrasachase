<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bus - VITRASA CHASE</title>
<style>
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#071226;color:#fff;padding:18px}
  .card{background:#071a2b;padding:14px;border-radius:10px;margin:10px 0}
  h1{margin:0 0 6px}
  .small{color:#9aa7b8;font-size:13px}
  .actions{display:flex;gap:10px;margin-top:12px}
  button{padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn-primary{background:#1e88e5;color:white}
  .btn-danger{background:#ef4444;color:white}
  .log{margin-top:12px;font-size:13px;color:#bcd}
</style>
</head>
<body>

<div class="card">
  <h1 id="title">Autob√∫s</h1>
  <div class="small" id="subtitle">Cargando...</div>

  <div style="margin-top:12px">
    <strong>Estado del veh√≠culo</strong>
    <div id="busState" class="small">‚Äî</div>
  </div>

  <div class="actions">
    <button class="btn-primary" id="timbreBtn">üîî Timbre</button>
    <button class="btn-danger" id="bajarBtn">üöè Bajarse</button>
  </div>

  <div class="log" id="log"></div>
</div>

<div style="margin-top:8px">
  <a href="parada.html">‚Üê Volver a paradas</a>
</div>

<script type="module">
  import { qs, loadJSON, BUSES_URL, GameState } from './logic.js';

  (async function(){
    const linea = qs('linea') || '??';
    const parada = qs('parada') || '‚Äî';
    const title = document.getElementById('title');
    const subtitle = document.getElementById('subtitle');
    const busState = document.getElementById('busState');
    const timbreBtn = document.getElementById('timbreBtn');
    const bajarBtn = document.getElementById('bajarBtn');
    const log = document.getElementById('log');

    title.textContent = `L√≠nea ${linea}`;
    subtitle.textContent = `Subido en parada ${parada}`;

    // intentar leer info real de buses.json
    const buses = await loadJSON(BUSES_URL);
    // buscar un bus plantilla para la linea
    let busInfo = null;
    if (Array.isArray(buses)) {
      busInfo = buses.find(b => b.linea === linea || (b.lineas && b.lineas.includes(linea)));
    }

    if (!busInfo) {
      // crear simulaci√≥n ligera
      busInfo = {
        id: 'sim-' + Math.floor(Math.random()*9000+1000),
        linea,
        tipo: 'est√°ndar',
        capacidad: 30,
        ocupados: Math.floor(Math.random()*10)
      };
    }

    busState.innerHTML = `N¬∫ veh√≠culo: <strong>${busInfo.id}</strong><br>Tipo: ${busInfo.tipo} ¬∑ Ocupados: ${busInfo.ocupados}/${busInfo.capacidad}`;

    function addLog(text) {
      const t = new Date().toLocaleTimeString();
      log.innerHTML = `<div>[${t}] ${text}</div>` + log.innerHTML;
    }

    timbreBtn.addEventListener('click', () => {
      addLog('Has pulsado el timbre. El conductor recibe la petici√≥n de parada.');
      // Simular que la petici√≥n hace que la pr√≥xima parada est√© marcada
      sessionStorage.setItem('ultimaPeticion', JSON.stringify({ linea, parada, when: Date.now() }));
    });

    bajarBtn.addEventListener('click', () => {
      addLog('Te bajas del autob√∫s. Te devolvemos a la parada m√°s cercana.');
      // Simular que te bajas en la parada actual (redirigir a parada.html)
      window.location.href = `parada.html?parada=${encodeURIComponent(parada)}`;
    });

    // auto-actualizaci√≥n del estado cada X segundos (simulaci√≥n)
    setInterval(() => {
      // variaci√≥n ligera en ocupaci√≥n
      busInfo.ocupados = Math.min(busInfo.capacidad, Math.max(0, busInfo.ocupados + (Math.random() > 0.5 ? 1 : -1)));
      busState.innerHTML = `N¬∫ veh√≠culo: <strong>${busInfo.id}</strong><br>Tipo: ${busInfo.tipo} ¬∑ Ocupados: ${busInfo.ocupados}/${busInfo.capacidad}`;
    }, 5000);

  })();
</script>
</body>
</html>
