<!doctype html>
<html lang="es">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Parada</title>
<link rel="stylesheet" href="styles.css"></head>
<body>
  <main class="container">
    <header class="card">
      <h3 id="paradaName">Parada</h3>
      <p id="paradaId" class="muted"></p>
    </header>

    <section class="card">
      <div id="paradaLines">Cargando líneas...</div>
      <div id="nearbyBox" style="margin-top:10px;">
        <!-- El usuario (tú) dejará aquí los recuadros de paradas cercanas; el procesador sólo expone el contenedor -->
        <p class="muted">Coloca aquí tus recuadros de "caminar a..."</p>
      </div>
    </section>

    <section class="card">
      <button class="btn" id="backToRoom">↩ Volver a la sala</button>
    </section>
  </main>

<script src="common.js"></script>
<script>
/* parada.html: obtiene ?stop=ID y muestra datos */
document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const stop = params.get('stop') || null;
  const nameEl = document.getElementById('paradaName');
  const idEl = document.getElementById('paradaId');

  if (!stop) {
    nameEl.textContent = 'Error: falta parámetro stop';
    return;
  }
  idEl.textContent = 'ID: ' + stop;

  // intentar cargar paradas.json y lineas.json; si no existen, usamos fallback mínimo
  let paradas = {};
  try {
    const r = await fetch('/paradas.json');
    if (r.ok) paradas = await r.json();
  } catch (e) { /* ignore */ }

  const parada = paradas[stop] || {nombre: 'Parada ' + stop, coords: null};
  nameEl.textContent = parada.nombre;

  // Cargar lineas y filtrar las que pasan por esta parada
  let lineas = [];
  try {
    const rl = await fetch('/lineas.json');
    if (rl.ok) {
      const lj = await rl.json();
      lineas = (lj || []).filter(l => Array.isArray(l.paradas) && l.paradas.includes(stop));
    }
  } catch (e) {}

  const linesContainer = document.getElementById('paradaLines');
  if (lineas.length === 0) {
    linesContainer.innerHTML = '<p class="muted">No se han encontrado líneas (usando simulación).</p>';
    // simulación simple: mostramos 3 ejemplos
    linesContainer.innerHTML += '<ul><li>C1 — cada 10 min</li><li>L10 — cada 20 min</li><li>N1 — nocturno</li></ul>';
  } else {
    linesContainer.innerHTML = '<ul>' + lineas.map(L=>`<li>${L.id} — ${L.nombre} (${L.tipo||'diurno'})</li>`).join('') + '</ul>';
  }

  document.getElementById('backToRoom').addEventListener('click', ()=> {
    // si estamos en iframe, usamos postMessage para avisar a la sala, si no, cerramos
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({type:'parada_closed', stop}, '*');
    } else {
      window.history.back();
    }
  });
});
</script>
</body>
</html>
